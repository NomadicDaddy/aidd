# AIDD Fixes - 2026-01-10

## Issue: Agent Terminated Early Despite 98 Open Features

### Root Cause Analysis

AIDD was terminating after continuations 8-37 with the message "MVP Complete" even though:
- 98 features had `"passes": false` in feature_list.json
- 38 todos remained unaddressed

Investigation revealed TWO separate issues:

### Issue 1: Agent's Faulty Logic (Inventing Filters)

**Location:** `prompts/coding.md` Step 5.2

**Problem:** The agent was inventing a distinction between "MVP-required" and "post-MVP" features that doesn't exist in the workflow:

1. Agent read `spec.txt` and saw "Priority Implementation Order: Phases 1-5"
2. Agent read `spec.txt` "Non-Goals" section mentioning "post-MVP" features  
3. **Agent invented** a filter: "MVP-required features" (Phases 1-5) vs "post-MVP enhancements"
4. Agent only counted the 30 "MVP-required" features instead of ALL 128 features
5. Concluded termination conditions met since 30/30 were passing

**Fix:** [commit b2fb15c]
- Made Step 5.1 explicit: "The count is the LITERAL count, no filtering, no interpretation"
- Made Step 5.2 explicit: "Count ALL features - do NOT filter by priority, category, or any other field"
- Added CRITICAL RULES forbidding MVP/post-MVP distinctions
- Added rule: "Do NOT interpret spec.txt phases or categories as filters"

**Evidence in Logs:**
```
5. **Completion Check (Step 5):**
   - Total MVP features passing: 30/30 (100%)
   - Failing features: 98 (all post-MVP enhancements)

7. **Early Termination Conditions Met (Step 5.2):**
   - âœ… Zero MVP-required features with "passes": false
```

### Issue 2: Status Not Being Regenerated

**Location:** `aidd.sh` lines 262-280 (original)

**Problem:** Status.md was only generated AFTER successful iterations (exit code 0):

```bash
if [[ $CLI_EXIT_CODE -ne 0 ]]; then
    handle_failure "$CLI_EXIT_CODE"  # <-- Goes here, skips status
else
    # Generate status report after every iteration  # <-- Only runs if exit==0
    log_info "Generating project status..."
}
```

The agent was exiting with code 1 even when completing "successfully", so status generation was always skipped.

**Why exit code 1?** Claude Code CLI returns exit code 1 when the agent stops early (even if stopping cleanly/successfully), as opposed to being explicitly told to continue.

**Fix:** [commit aba463d]
- Moved status generation to BEFORE invoking the agent
- Moved completion check to BEFORE invoking the agent  
- Applied to both unlimited and fixed iteration loops
- Removed status generation from success-only code path

**Benefits:**
- Status always reflects current state at start of each iteration
- Not dependent on agent's exit code or completion behavior
- Completion check saves API calls by detecting completion before invoking agent
- If agent hangs/crashes, status file is still up-to-date

### Issue 3: Unclear Exit Instructions

**Location:** `prompts/coding.md` Step 5.2

**Problem:** Workflow said "Exit with code 0" but didn't explain HOW, since the agent can't directly control Claude Code's exit code.

**Fix:** [commit 6d7416d]
- Clarified that agent should "complete the session successfully" without errors
- Added note that CLI will handle exit code based on clean completion
- Added warning not to use error-indicating completion methods

## Testing

To verify fixes work:
1. Run `aidd.sh` with project that has failing features
2. Check that `status.md` is generated before each iteration (in logs)
3. Check that agent counts ALL features, not just "MVP-required" ones
4. Check that agent continues working on failing features instead of terminating

## Files Modified

- `prompts/coding.md` - Steps 5.1, 5.2 (agent workflow logic)
- `aidd.sh` - Status generation timing (both iteration loops)

## Commits

- b2fb15c: Fix workflow Step 5: prevent agent from inventing MVP/post-MVP filter
- 6d7416d: Clarify Step 5.2: agent should exit cleanly without errors  
- aba463d: Move status generation to before prompt invocation
